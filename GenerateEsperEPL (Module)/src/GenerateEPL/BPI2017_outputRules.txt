// create a table to hold the state of the current caseID
create table Cases (caseID long primary key);

//an incoming stream of unlabeled events (activity name and its timestamp) 
create schema UnlabeledEvent(caseID long, activity string, timestamp long, probability double);
@Name('Unlabeled') select * from UnlabeledEvent;

//an outgoing stream of final labeled events (caseID, activity name, its timestamp, calculated probability )
create schema LabeledEvent(caseID long, activity string, timestamp long, probability double);
@Name('Labeled') select * from LabeledEvent;

//an intermediate stream to check the possible labels for incoming unlabeled events. These should be temporary and need to be deleted after usage. 
create schema TempEvent (caseID long, activity string, timestamp long, probability double);
@Name('TempEvent') select * from TempEvent ;
@Name('Unlabeled') select * from UnlabeledEvent; 
@Name('Labeled') select * from LabeledEvent; 
 @Name('FilterLabeledEvent') select * from FilterLabeledEvent; 
@Name('Temp') select * from TempEvent ; 
@Name('get_case_ID')  insert into Cases  select (select coalesce(max(caseID)+1, 1)  from  Cases )  as caseID from UnlabeledEvent  where  activity in ('a_create application');  
@Name('start_case_a_create_application')  insert into FilterLabeledEvent (caseID, activity, timestamp, probability, initTime)  select (select coalesce(max(caseID)+1,1) from Cases) as caseID, UE.activity, UE.timestamp, 1.0, UE.sysTime as initTime  from UnlabeledEvent as UE where UE.activity = 'a_create application'; 

@Priority(5) @Name('TE_a_submitted') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_submitted' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity = 'a_create application') -> every succ=UnlabeledEvent(activity='a_submitted')) where timer:within(2 min)]#time(2 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=60;

@Priority(20) @Name('Correlate_a_submitted') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_submitted'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_submitted') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_submitted'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_complete_application') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_complete application' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_complete application')) where timer:within(32033 min)]#time(32033 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=1921920;

@Priority(20) @Name('Correlate_w_complete_application') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_complete application'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_complete_application') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_complete application'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_handle_leads') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_handle leads' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_handle leads')) where timer:within(4190 min)]#time(4190 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=251340;

@Priority(20) @Name('Correlate_w_handle_leads') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_handle leads'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_handle_leads') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_handle leads'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_concept') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_concept' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_concept')) where timer:within(6847 min)]#time(6847 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=410760;

@Priority(20) @Name('Correlate_a_concept') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_concept'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_concept') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_concept'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_accepted') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_accepted' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_accepted')) where timer:within(43767 min)]#time(43767 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=2625960;

@Priority(20) @Name('Correlate_a_accepted') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_accepted'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_accepted') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_accepted'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_complete') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_complete' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_complete')) where timer:within(2 min)]#time(2 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=60;

@Priority(20) @Name('Correlate_a_complete') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_complete'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_complete') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_complete'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_assess_potential_fraud') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_assess potential fraud' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_assess potential fraud')) where timer:within(127008 min)]#time(127008 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=7620420;

@Priority(20) @Name('Correlate_w_assess_potential_fraud') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_assess potential fraud'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_assess_potential_fraud') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_assess potential fraud'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_refused') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_refused' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_refused')) where timer:within(2 min)]#time(2 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=60;

@Priority(20) @Name('Correlate_o_refused') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_refused'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_refused') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_refused'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_validate_application') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_validate application' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_validate application')) where timer:within(132563 min)]#time(132563 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=7953720;

@Priority(20) @Name('Correlate_w_validate_application') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_validate application'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_validate_application') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_validate application'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_call_after_offers') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_call after offers' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_call after offers')) where timer:within(106479 min)]#time(106479 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=6388680;

@Priority(20) @Name('Correlate_w_call_after_offers') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_call after offers'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_call_after_offers') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_call after offers'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_cancelled') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_cancelled' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_cancelled')) where timer:within(201747 min)]#time(201747 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=12104760;

@Priority(20) @Name('Correlate_a_cancelled') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_cancelled'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_cancelled') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_cancelled'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_returned') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_returned' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_returned')) where timer:within(50302 min)]#time(50302 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=3018060;

@Priority(20) @Name('Correlate_o_returned') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_returned'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_returned') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_returned'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_incomplete') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_incomplete' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_incomplete')) where timer:within(17542 min)]#time(17542 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=1052460;

@Priority(20) @Name('Correlate_a_incomplete') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_incomplete'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_incomplete') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_incomplete'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_created') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_created' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_created')) where timer:within(2 min)]#time(2 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=60;

@Priority(20) @Name('Correlate_o_created') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_created'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_created') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_created'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_pending') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_pending' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_pending')) where timer:within(2 min)]#time(2 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=60;

@Priority(20) @Name('Correlate_a_pending') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_pending'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_pending') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_pending'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_call_incomplete_files') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_call incomplete files' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_call incomplete files')) where timer:within(175871 min)]#time(175871 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=10552200;

@Priority(20) @Name('Correlate_w_call_incomplete_files') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_call incomplete files'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_call_incomplete_files') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_call incomplete files'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_shortened_completion') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_shortened completion' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_shortened completion')) where timer:within(4353 min)]#time(4353 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=261120;

@Priority(20) @Name('Correlate_w_shortened_completion') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_shortened completion'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_shortened_completion') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_shortened completion'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_sent__mail_and_online_') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_sent (mail and online)' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_sent (mail and online)')) where timer:within(21871 min)]#time(21871 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=1312200;

@Priority(20) @Name('Correlate_o_sent__mail_and_online_') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_sent (mail and online)'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_sent__mail_and_online_') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_sent (mail and online)'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_validating') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_validating' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_validating')) where timer:within(132469 min)]#time(132469 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=7948080;

@Priority(20) @Name('Correlate_a_validating') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_validating'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_validating') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_validating'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_create_offer') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_create offer' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_create offer')) where timer:within(161375 min)]#time(161375 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=9682440;

@Priority(20) @Name('Correlate_o_create_offer') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_create offer'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_create_offer') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_create offer'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_sent__online_only_') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_sent (online only)' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_sent (online only)')) where timer:within(12817 min)]#time(12817 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=768960;

@Priority(20) @Name('Correlate_o_sent__online_only_') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_sent (online only)'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_sent__online_only_') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_sent (online only)'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_a_denied') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'a_denied' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='a_denied')) where timer:within(48967 min)]#time(48967 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=2937960;

@Priority(20) @Name('Correlate_a_denied') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'a_denied'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_a_denied') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'a_denied'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_accepted') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_accepted' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_accepted')) where timer:within(74561 min)]#time(74561 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=4473600;

@Priority(20) @Name('Correlate_o_accepted') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_accepted'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_accepted') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_accepted'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_o_cancelled') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'o_cancelled' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='o_cancelled')) where timer:within(97658 min)]#time(97658 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=5859420;

@Priority(20) @Name('Correlate_o_cancelled') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'o_cancelled'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_o_cancelled') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'o_cancelled'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

@Priority(5) @Name('TE_w_personal_loan_collection') insert into TempEvent (caseID, activity, timestamp) select distinct pred.caseID, 'w_personal loan collection' as activity, succ.timestamp as timestamp from pattern [(every pred=FilterLabeledEvent(activity='a_create application' or activity='a_submitted' or activity='w_complete application' or activity='w_handle leads' or activity='a_concept' or activity='a_accepted' or activity='a_complete' or activity='w_assess potential fraud' or activity='o_refused' or activity='w_validate application' or activity='w_call after offers' or activity='a_cancelled' or activity='o_returned' or activity='a_incomplete' or activity='o_created' or activity='a_pending' or activity='w_call incomplete files' or activity='w_shortened completion' or activity='o_sent (mail and online)' or activity='a_validating' or activity='o_create offer' or activity='o_sent (online only)' or activity='a_denied' or activity='o_accepted' or activity='o_cancelled' or activity='w_personal loan collection )') -> every succ=UnlabeledEvent(activity='w_personal loan collection')) where timer:within(192098 min)]#time(192098 min)  where (succ.timestamp - pred.timestamp) >= 0 and (succ.timestamp - pred.timestamp) <=11525820;

@Priority(20) @Name('Correlate_w_personal_loan_collection') insert into LabeledEvent (caseID, activity , timestamp, probability) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , min(((select count(caseID)  from TempEvent.win:time_batch(1 sec) where caseID = T.caseID and activity = T.activity and timestamp=T.timestamp) /count(all caseID, group_by:timestamp)),1.0) as probability from TempEvent.win:time_batch(1 sec) as T  where activity = 'w_personal loan collection'  group by caseID order by timestamp desc limit 3 ; 

@Priority(50) @Name('Filter_w_personal_loan_collection') insert into FilterLabeledEvent (caseID, activity , timestamp, probability, initTime) select distinct caseID as caseID, last(activity) as activity, max(timestamp) as timestamp , probability,  "+initTime+" from LabeledEvent.win:time(1 sec) as T where activity = 'w_personal loan collection'  and probability >= 0.0 group by caseID order by probability desc limit 3 ;

